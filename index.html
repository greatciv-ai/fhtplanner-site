<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Flint Hills Trail Resource Finder (Beta)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .chip { border: 1px solid #d1d5db; background:#f3f4f6; color:#374151; }
    .chip.active { background:#166534; color:#fff; border-color:#166534; }
  </style>
</head>
<body class="min-h-screen bg-stone-100 font-sans p-4 sm:p-8 flex items-center justify-center">
  <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl overflow-hidden">
    <header class="bg-green-700 text-white p-6 sm:p-8">
      <h1 class="text-2xl sm:text-4xl font-bold text-center">Flint Hills Trail Resource Finder (Beta)</h1>
      <p class="mt-2 text-center text-sm sm:text-base opacity-90">Find businesses and services along your route.</p>
      <div id="betaDisclaimer" class="mt-4 bg-yellow-100 text-yellow-800 text-sm p-3 rounded-lg max-w-2xl mx-auto flex justify-between items-start">
        <span>
          <strong>Beta Disclaimer:</strong> This site is in active development. Resource listings and reviews are provided as-is and may not always be complete or up to date. Please verify details independently before planning your trip.
        </span>
        <button id="dismissDisclaimer" class="ml-3 px-2 py-1 bg-yellow-200 text-yellow-800 rounded hover:bg-yellow-300 text-xs font-semibold">
          Got it
        </button>
      </div>
    </header>

    <main class="p-6 sm:p-8">
      <div id="loading" class="text-center text-gray-600">Loading resources…</div>

      <form id="plannerForm" class="hidden">
        <!-- Route -->
        <div class="mb-8">
          <h2 class="text-xl font-bold text-gray-800 border-b pb-2 mb-4">1. Select Your Route</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="startTown" class="block text-sm font-medium text-gray-700 mb-1">Start Town</label>
              <select id="startTown" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-green-500 focus:border-green-500"></select>
            </div>
            <div>
              <label for="endTown" class="block text-sm font-medium text-gray-700 mb-1">End Town</label>
              <select id="endTown" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-green-500 focus:border-green-500"></select>
            </div>
          </div>
        </div>

        <!-- Services -->
        <div class="mb-4">
          <h2 class="text-xl font-bold text-gray-800 border-b pb-2 mb-4">2. Choose Services to Find</h2>
          <div id="serviceChips" class="flex flex-wrap gap-3"></div>
        </div>

        <div id="errorBox" class="mt-4 text-center text-red-600 bg-red-100 p-3 rounded-lg hidden"></div>

        <button type="submit" class="mt-4 w-full bg-green-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg hover:bg-green-700 transition-all transform hover:scale-105">
          Find Resources
        </button>
      </form>

      <!-- Results -->
      <section id="results" class="hidden mt-8">
        <h2 class="text-2xl font-bold text-gray-800">Resources Found</h2>
        <p id="resultSubtitle" class="text-gray-600 mb-6"></p>
        <div id="resultList" class="space-y-4"></div>
        <button id="newSearchBtn" class="mt-8 w-full bg-stone-500 text-white font-bold py-3 px-4 rounded-xl shadow-lg hover:bg-stone-600 transition-all transform hover:scale-105">
          Start a New Search
        </button>
      </section>
    </main>
  </div>

  <script>
    /* ---------------- CONFIG ---------------- */
    const RESOURCES_URL = '/resources.json';
    const REVIEWS_URL   = '/reviews.json';

    // Google Form + Resource ID field
    const FORM_BASE_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSfQR46U21K6E5G1Lucv7zD4Zr9ojmsCGminW2MlpzcAPwa2jA/viewform';
    const FORM_RESOURCE_PARAM = 'entry.1477080210';

    // ✅ Your updated mileages (Herington removed)
    const TRAIL_TOWNS = [
      { id: 'osawatomie',    name: 'Osawatomie',    mileage: 0 },
      { id: 'rantoul',       name: 'Rantoul',       mileage: 9 },
      { id: 'ottawa',        name: 'Ottawa',        mileage: 20 },
      { id: 'pomona',        name: 'Pomona',        mileage: 30.5 },
      { id: 'vassar',        name: 'Vassar',        mileage: 41 },
      { id: 'osage-city',    name: 'Osage City',    mileage: 52.5 },
      { id: 'miller',        name: 'Miller',        mileage: 62 },
      { id: 'admire',        name: 'Admire',        mileage: 68.5 },
      { id: 'allen',         name: 'Allen',         mileage: 72 },
      { id: 'bushong',       name: 'Bushong',       mileage: 77.5 },
      { id: 'council-grove', name: 'Council Grove', mileage: 92 }
    ];

    /* ---------------- STATE ---------------- */
    let ALL_RESOURCES = [];
    let REVIEWS_BY_ID = {};
    let SELECTED_TYPES = new Set();

    /* ---------------- DOM ---------------- */
    const loadingEl = document.getElementById('loading');
    const plannerForm = document.getElementById('plannerForm');
    const startTownSel = document.getElementById('startTown');
    const endTownSel = document.getElementById('endTown');
    const chipsWrap = document.getElementById('serviceChips');
    const errorBox = document.getElementById('errorBox');
    const resultsSection = document.getElementById('results');
    const resultSubtitle = document.getElementById('resultSubtitle');
    const resultList = document.getElementById('resultList');
    const newSearchBtn = document.getElementById('newSearchBtn');

    /* ---------------- HELPERS ---------------- */
    function show(el){el.classList.remove('hidden');}
    function hide(el){el.classList.add('hidden');}
    function setError(msg){
      if(!msg){ hide(errorBox); errorBox.textContent=''; return; }
      errorBox.textContent = msg; show(errorBox);
    }
    function getTownById(id){ return TRAIL_TOWNS.find(t => t.id === id); }
    function formatMiles(x){ return isNaN(x) ? '—' : Number(x).toFixed(1).replace(/\.0$/, ''); }
    function starStr(n){
      const s=Math.max(0,Math.min(5,Number(n)||0));
      return '★'.repeat(s)+'☆'.repeat(5-s);
    }
    function reviewLink(resourceId){
      const u = new URL(FORM_BASE_URL);
      u.searchParams.set(FORM_RESOURCE_PARAM, resourceId);
      return u.toString();
    }

    /* ---------------- DISCLAIMER ---------------- */
    (function setupDisclaimer(){
      const disclaimer = document.getElementById('betaDisclaimer');
      const dismissBtn = document.getElementById('dismissDisclaimer');
      if (!disclaimer || !dismissBtn) return;
      if (localStorage.getItem('dismissedDisclaimer') === 'true') {
        disclaimer.style.display = 'none';
      }
      dismissBtn.addEventListener('click', () => {
        disclaimer.style.display = 'none';
        localStorage.setItem('dismissedDisclaimer', 'true');
      });
    })();

    /* ---------------- RENDER ---------------- */
    function renderTownSelects(){
      const opts = TRAIL_TOWNS
        .map(t => `<option value="${t.id}">${t.name} (Mile ${t.mileage})</option>`)
        .join('');
      startTownSel.innerHTML = opts;
      endTownSel.innerHTML = opts;
      startTownSel.value = 'osawatomie';
      endTownSel.value = 'council-grove';
    }

    function renderServiceChips(){
      const types = [...new Set(ALL_RESOURCES.map(r => r.type).filter(Boolean))].sort(); // ✅ fixed spread
      chipsWrap.innerHTML = '';
      types.forEach(type => {
        const label = document.createElement('label');
        label.className = 'chip flex items-center px-3 py-1.5 rounded-full text-sm cursor-pointer transition-colors';
        label.textContent = type;
        label.addEventListener('click', () => {
          if (SELECTED_TYPES.has(type)) {
            SELECTED_TYPES.delete(type);
            label.classList.remove('active');
          } else {
            SELECTED_TYPES.add(type);
            label.classList.add('active');
          }
        });
        chipsWrap.appendChild(label);
      });
    }

    function renderResults(found, startName, endName){
      resultSubtitle.textContent = `Showing results for your trip from ${startName} to ${endName}.`;
      resultList.innerHTML = '';

      if (!found.length){
        resultList.innerHTML = `
          <div class="text-center py-8 px-4 bg-gray-50 rounded-lg">
            <p class="text-gray-600">No resources matched your search criteria.</p>
            <p class="text-sm text-gray-500 mt-1">Try selecting different services or expanding your route.</p>
          </div>`;
        return;
      }

      found.forEach(res => {
        const town = getTownById(res.nearestTownId);
        const reviews = REVIEWS_BY_ID[res.id] || [];

        const card = document.createElement('div');
        card.className = 'p-4 bg-gray-50 rounded-xl border border-gray-200 shadow-sm';

        const websiteBtn = res.websiteUrl
          ? `<a href="${res.websiteUrl}" target="_blank" rel="noopener noreferrer"
               class="inline-block mt-2 ml-2 px-3 py-1 bg-stone-600 text-white text-sm rounded-full hover:bg-stone-700">Website</a>`
          : '';

        const desc = res.description ? `<p class="text-sm text-gray-600 mt-2">${res.description}</p>` : '';

        const reviewsHtml = reviews.length
          ? reviews.map(rv => `
              <div class="p-2 bg-white border rounded">
                <div class="flex items-center text-sm">
                  <span class="font-bold text-gray-800">${rv.author || 'Anonymous'}</span>
                  <span class="ml-2 text-yellow-500">${starStr(rv.rating)}</span>
                  <span class="ml-auto text-xs text-gray-400">${rv.created_at ? new Date(rv.created_at).toLocaleDateString() : ''}</span>
                </div>
                ${rv.comment ? `<p class="text-gray-700 text-sm mt-1">${rv.comment}</p>` : ''}
              </div>
            `).join('')
          : `<p class="text-sm text-gray-500 mt-1">No reviews yet. Be the first!</p>`;

        card.innerHTML = `
          <h3 class="text-lg font-bold text-gray-900">${res.name}</h3>
          <div class="flex flex-wrap items-center text-sm text-gray-500 mt-1">
            <span>Near: ${town ? `${town.name} (Mile ${town.mileage})` : 'N/A'}</span>
            <span class="mx-2">|</span>
            <span>~${formatMiles(res.distanceFromTrail)} mi from trail</span>
          </div>
          ${desc}
          <div class="mt-2">
            ${res.googleMapsUrl ? `
              <a href="${res.googleMapsUrl}" target="_blank" rel="noopener noreferrer"
                 class="inline-block mt-2 px-3 py-1 bg-blue-500 text-white text-sm rounded-full hover:bg-blue-600">Google Maps</a>` : ''}
            ${websiteBtn}
            <a href="${reviewLink(res.id)}" target="_blank" rel="noopener noreferrer"
               class="inline-block mt-2 ml-2 px-3 py-1 bg-green-600 text-white text-sm rounded-full hover:bg-green-700">Leave a Review</a>
          </div>
          <div class="mt-4 pt-3 border-t border-gray-200">
            <h4 class="font-semibold text-gray-700">Reviews</h4>
            <div class="space-y-3 mt-2">${reviewsHtml}</div>
          </div>
        `;
        resultList.appendChild(card);
      });
    }

    /* ---------------- SEARCH ---------------- */
    function handleSearch(e){
      e.preventDefault();
      setError('');

      const start = getTownById(startTownSel.value);
      const end = getTownById(endTownSel.value);
      const services = Array.from(SELECTED_TYPES);

      if (!start || !end){ setError('Please select a valid start and end town.'); return; }
      if (!services.length){ setError('Please select at least one service to search for.'); return; }

      const minM = Math.min(start.mileage, end.mileage);
      const maxM = Math.max(start.mileage, end.mileage);
      const townsOnRoute = new Set(TRAIL_TOWNS.filter(t => t.mileage >= minM && t.mileage <= maxM).map(t => t.id));
      const found = ALL_RESOURCES.filter(r => services.includes(r.type) && townsOnRoute.has(r.nearestTownId));

      renderResults(found, start.name, end.name);
      hide(plannerForm);
      show(resultsSection);
    }

    newSearchBtn.addEventListener('click', () => {
      show(plannerForm);
      hide(resultsSection);
      setError('');
    });

    /* ---------------- INIT ---------------- */
    async function init(){
      try {
        const [resRes, revRes] = await Promise.all([
          fetch(RESOURCES_URL + '?ts=' + Date.now(), { cache: 'no-store' }),
          fetch(REVIEWS_URL   + '?ts=' + Date.now(), { cache: 'no-store' })
        ]);

        if (!resRes.ok) throw new Error(`Failed to load resources.json (${resRes.status})`);
        ALL_RESOURCES = await resRes.json();

        if (revRes.ok) {
          REVIEWS_BY_ID = await revRes.json();
        } else {
          REVIEWS_BY_ID = {};
        }

        renderTownSelects();
        renderServiceChips();
        show(plannerForm);
      } catch (err) {
        console.error(err);
        loadingEl.textContent = 'Failed to load resources. Make sure resources.json is in the site root.';
        return;
      } finally {
        hide(loadingEl);
      }
    }

    plannerForm.addEventListener('submit', handleSearch);
    init();
  </script>
</body>
</html>
